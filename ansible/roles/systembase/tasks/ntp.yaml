---
# file: roles/systembase/tasks/ntp.yml

- name: (sys) be sure "systemd-timesyncd" is installed
  ansible.builtin.apt:
    name: systemd-timesyncd
    state: present
  tags: ntp

- name: (sys) be sure "systemd-timesyncd" is configured
  ansible.builtin.template:
    src: timesyncd.conf.j2
    dest: /etc/systemd/timesyncd.conf
    mode: u=rw,g=r,o=r
  notify: restart systemd-timesyncd
  tags: ntp

- name: (sys) be sure "systemd-timesyncd" is running and enabled
  ansible.builtin.service:
    name: systemd-timesyncd
    state: started
    enabled: true
  tags: ntp

- name: (sys) prevent setting NTP server from DHCP
  block:
    - name: Delete timesyncd dhclient hook
      ansible.builtin.file:
        path: /etc/dhcp/dhclient-exit-hooks.d/timesyncd
        state: absent

    - name: Delete timesyncd runtime config generated from dhclient hook
      ansible.builtin.file:
        path: /run/systemd/timesyncd.conf.d/01-dhclient.conf
        state: absent
      notify: restart systemd-timesyncd
